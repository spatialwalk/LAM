# æ•´åˆçš„å¤´åƒç”Ÿæˆç³»ç»Ÿä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

`integrated_avatar_generation.py` æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯åˆ°ç«¯å¤´åƒç”Ÿæˆç³»ç»Ÿï¼Œæ•´åˆäº†ä»¥ä¸‹åŠŸèƒ½ï¼š
1. VHAPæ•°æ®è½¬æ¢ä¸ºLAMå…¼å®¹æ ¼å¼
2. å¤šè§†è§’å¤´åƒè§†é¢‘ç”Ÿæˆ
3. è‡ªåŠ¨è§†é¢‘å¤„ç†å’ŒéŸ³é¢‘æå–
4. ç»Ÿä¸€çš„å·¥ä½œæµç¨‹ç®¡ç†

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”„ æ•°æ®è½¬æ¢
- è‡ªåŠ¨è½¬æ¢VHAPè¾“å‡ºä¸ºLAMå…¼å®¹æ ¼å¼
- æ”¯æŒå¤šç§è§†é¢‘æ ¼å¼è¾“å…¥ï¼ˆ.mp4/.mov/.avi/.mkvç­‰ï¼‰
- è‡ªåŠ¨æå–éŸ³é¢‘æ–‡ä»¶
- ç”Ÿæˆå®Œæ•´çš„é©±åŠ¨æ•°æ®ç»“æ„

### ğŸ¬ å¤šè§†è§’ç”Ÿæˆ
- æ”¯æŒå¤šä¸ªåèˆªè§’ï¼ˆyawï¼‰å’Œä¿¯ä»°è§’ï¼ˆpitchï¼‰ç»„åˆ
- æ‰¹é‡ç”Ÿæˆä¸åŒè§†è§’çš„å¤´åƒè§†é¢‘
- è‡ªåŠ¨éŸ³é¢‘åŒæ­¥
- é«˜è´¨é‡è§†é¢‘è¾“å‡º

### ğŸ› ï¸ è‡ªåŠ¨åŒ–æµç¨‹
- ä¸€é”®å®Œæˆä»åŸå§‹æ•°æ®åˆ°æœ€ç»ˆè§†é¢‘çš„å…¨æµç¨‹
- æ™ºèƒ½é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥
- è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤ºå’Œæ—¥å¿—è¾“å‡º

## å®‰è£…è¦æ±‚

```bash
# åŸºç¡€ä¾èµ–
pip install torch torchvision
pip install opencv-python pillow
pip install moviepy numpy
pip install omegaconf argparse
pip install tqdm pathlib

# LAMç›¸å…³ä¾èµ–
# è¯·ç¡®ä¿å·²æ­£ç¡®å®‰è£…LAMæ¡†æ¶å’Œç›¸å…³æ¨¡å‹
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
python integrated_avatar_generation.py \
    --input_image /path/to/your/image.jpg \
    --source_video /path/to/your/video.mp4 \
    --output_dir ./output_results/
```

### å®Œæ•´å‚æ•°ç¤ºä¾‹

```bash
python integrated_avatar_generation.py \
    --input_image /root/autodl-tmp/datasets/mono_jp/apple_jp_3/images_4/000000.jpg \
    --source_video /root/autodl-tmp/datasets/mono_jp/apple_jp_3.mov \
    --vhap_dir /root/autodl-tmp/VHAP_track/mono_jp/export_epoch0 \
    --output_dir ./output_integrated/ \
    --drive_name custom_jp_drive \
    --model_name /root/autodl-tmp/LAM/model_zoo/lam_models/releases/lam/lam-20k/step_045500 \
    --yaw_angles -30 -20 -10 0 10 20 30 \
    --pitch_angles -10 -5 0 5 10 \
    --max_frames 264
```

## å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°
- `--input_image`: è¾“å…¥çš„äººåƒå›¾ç‰‡è·¯å¾„
- `--source_video`: æºè§†é¢‘æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºé©±åŠ¨ç”Ÿæˆï¼‰

### å¯é€‰å‚æ•°
- `--vhap_dir`: VHAPè¾“å‡ºç›®å½•è·¯å¾„ï¼ˆå¦‚æœéœ€è¦è½¬æ¢VHAPæ•°æ®ï¼‰
- `--output_dir`: è¾“å‡ºç›®å½•è·¯å¾„ï¼ˆé»˜è®¤ï¼š./output_integrated/ï¼‰
- `--drive_name`: é©±åŠ¨æ•°æ®åç§°ï¼ˆé»˜è®¤ï¼šcustom_integrated_driveï¼‰
- `--model_name`: LAMæ¨¡å‹è·¯å¾„
- `--yaw_angles`: åèˆªè§’åº¦åˆ—è¡¨ï¼ˆé»˜è®¤ï¼š-30åˆ°30åº¦ï¼‰
- `--pitch_angles`: ä¿¯ä»°è§’åº¦åˆ—è¡¨ï¼ˆé»˜è®¤ï¼š-10åˆ°10åº¦ï¼‰
- `--max_frames`: æœ€å¤§å¸§æ•°ï¼ˆé»˜è®¤ï¼š264ï¼‰

## å·¥ä½œæµç¨‹

### 1. æ•°æ®å‡†å¤‡é˜¶æ®µ
å¦‚æœæä¾›äº†`--vhap_dir`å‚æ•°ï¼š
```
VHAPæ•°æ® â†’ æ ¼å¼è½¬æ¢ â†’ LAMå…¼å®¹æ ¼å¼
æºè§†é¢‘ â†’ æ ¼å¼è½¬æ¢ â†’ MP4 + éŸ³é¢‘æå–
```

### 2. æ¨¡å‹åˆå§‹åŒ–
```
é¢„å¤„ç†å™¨åˆå§‹åŒ– â†’ FLAMEè·Ÿè¸ªå™¨åˆå§‹åŒ– â†’ LAMæ¨¡å‹åŠ è½½
```

### 3. å¤šè§†è§’ç”Ÿæˆ
```
è¾“å…¥å›¾ç‰‡é¢„å¤„ç† â†’ FLAMEå‚æ•°ä¼°è®¡ â†’ å¤šè§’åº¦è§†é¢‘ç”Ÿæˆ â†’ éŸ³é¢‘åˆæˆ
```

## è¾“å‡ºç»“æœ

ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„ï¼š
```
output_dir/
â”œâ”€â”€ output_yaw-30_pitch-10.png          # å¤„ç†åçš„å‚è€ƒå›¾ç‰‡
â”œâ”€â”€ output_yaw-30_pitch-10_audio.mp4    # å¸¦éŸ³é¢‘çš„æœ€ç»ˆè§†é¢‘
â”œâ”€â”€ output_yaw-20_pitch-5_audio.mp4
â”œâ”€â”€ ...
â””â”€â”€ debug_first_frame.png               # è°ƒè¯•ç”¨ç¬¬ä¸€å¸§å›¾ç‰‡
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä»VHAPæ•°æ®ç”Ÿæˆå¤šè§†è§’è§†é¢‘
```bash
# é€‚ç”¨äºå·²æœ‰VHAPå¤„ç†ç»“æœçš„æƒ…å†µ
python integrated_avatar_generation.py \
    --input_image portrait.jpg \
    --source_video driving_video.mp4 \
    --vhap_dir ./vhap_output/ \
    --output_dir ./results/
```

### åœºæ™¯2ï¼šä½¿ç”¨ç°æœ‰é©±åŠ¨æ•°æ®
```bash
# é€‚ç”¨äºå·²æœ‰LAMæ ¼å¼é©±åŠ¨æ•°æ®çš„æƒ…å†µ
python integrated_avatar_generation.py \
    --input_image portrait.jpg \
    --drive_name Joe_Biden \
    --output_dir ./results/
```

### åœºæ™¯3ï¼šè‡ªå®šä¹‰è§’åº¦èŒƒå›´
```bash
# åªç”Ÿæˆæ­£é¢å’Œè½»å¾®è½¬åŠ¨çš„è§†é¢‘
python integrated_avatar_generation.py \
    --input_image portrait.jpg \
    --source_video video.mp4 \
    --yaw_angles -10 0 10 \
    --pitch_angles -5 0 5
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. GPUå†…å­˜ä¼˜åŒ–
- å¦‚æœGPUå†…å­˜ä¸è¶³ï¼Œå¯ä»¥å‡å°`batch_size`ï¼ˆåœ¨ä»£ç ä¸­è°ƒæ•´ï¼‰
- è€ƒè™‘å‡å°‘åŒæ—¶ç”Ÿæˆçš„è§’åº¦æ•°é‡

### 2. é€Ÿåº¦ä¼˜åŒ–
- ä½¿ç”¨SSDå­˜å‚¨ä»¥æé«˜I/Oæ€§èƒ½
- ç¡®ä¿CUDAç¯å¢ƒæ­£ç¡®é…ç½®
- å¯ä»¥è°ƒæ•´`max_frames`å‚æ•°æ§åˆ¶è§†é¢‘é•¿åº¦

### 3. è´¨é‡ä¼˜åŒ–
- ä½¿ç”¨é«˜è´¨é‡çš„è¾“å…¥å›¾ç‰‡ï¼ˆå»ºè®®512x512æˆ–æ›´é«˜ï¼‰
- ç¡®ä¿è¾“å…¥å›¾ç‰‡äººè„¸æ¸…æ™°ä¸”å±…ä¸­
- é€‰æ‹©åˆé€‚çš„é©±åŠ¨è§†é¢‘ï¼ˆè¡¨æƒ…ä¸°å¯Œã€æ¸…æ™°åº¦é«˜ï¼‰

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**
   ```
   è§£å†³æ–¹æ¡ˆï¼šå‡å°‘batch_sizeæˆ–é™ä½render_size
   ```

2. **è§†é¢‘æ ¼å¼ä¸æ”¯æŒ**
   ```
   é”™è¯¯ï¼šä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼
   è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ”¯æŒçš„æ ¼å¼ï¼ˆ.mp4/.mov/.avi/.mkvç­‰ï¼‰
   ```

3. **FLAMEè·Ÿè¸ªå¤±è´¥**
   ```
   é”™è¯¯ï¼šflametracking preprocess failed
   è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥è¾“å…¥å›¾ç‰‡è´¨é‡ï¼Œç¡®ä¿äººè„¸æ¸…æ™°å¯è§
   ```

4. **æ¨¡å‹åŠ è½½å¤±è´¥**
   ```
   é”™è¯¯ï¼šæ¨¡å‹è·¯å¾„ä¸å­˜åœ¨
   è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥--model_nameå‚æ•°ï¼Œç¡®ä¿æ¨¡å‹æ–‡ä»¶å­˜åœ¨
   ```

### è°ƒè¯•æ¨¡å¼

åœ¨ä»£ç ä¸­è®¾ç½®è°ƒè¯•æ ‡å¿—ä»¥è·å–æ›´è¯¦ç»†çš„è¾“å‡ºï¼š
```python
# åœ¨main()å‡½æ•°å¼€å§‹å¤„æ·»åŠ 
import logging
logging.basicConfig(level=logging.DEBUG)
```

## æ›´æ–°æ—¥å¿—

### v1.0.0
- æ•´åˆVHAPè½¬æ¢å’Œå¤šè§†è§’ç”ŸæˆåŠŸèƒ½
- æ”¯æŒå¤šç§è§†é¢‘æ ¼å¼è¾“å…¥
- è‡ªåŠ¨éŸ³é¢‘å¤„ç†å’ŒåŒæ­¥
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥

## è´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueæˆ–Pull Requestã€‚

## è®¸å¯è¯

éµå¾ªåŸå§‹LAMé¡¹ç›®çš„Apache License 2.0è®¸å¯è¯ã€‚ 